<!DOCTYPE html>
<html lang="en">
<head>
    <title>Testing Ember.js Mixins (and Helpers) With a Container &middot; Chris Krycho</title>
    <meta name="description" content="Updated to note that the same concerns apply to helpers. You can always see the full revision history of this item here. Today I was working on an Ember.js mixin for the new mobile web application we‚Äôre shipping at Olo, and I ran into an interesting problem when ‚Ä¶"/>

    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1.0"/>

<link rel='me' href='https://alpha.app.net/chriskrycho' data-type='follow' data-user-id='@chriskrycho'/>    <meta property="og:url" content="http://v4.chriskrycho.com/2016/testing-emberjs-mixins-with-a-container.html"/>
    <meta property="og:title" content="Testing Ember.js Mixins (and Helpers) With a Container"/>
    <meta property="og:description" content="Updated to note that the same concerns apply to helpers. You can always see the full revision history of this item here. Today I was working on an Ember.js mixin for the new mobile web application we‚Äôre shipping at Olo, and I ran into an interesting problem when ‚Ä¶"/>
        <meta property="og:image" content="http://v4.chriskrycho.com//assets/images/ck.png"/>
<link rel="author" href=""/>
<link rel="me" href=""/><meta name="twitter:card" content="summary"/>
<meta name="twitter:site" content="@chriskrycho"/>
<meta name="twitter:creator" content="@chriskrycho"/>
    <meta name="twitter:title" content="Testing Ember.js Mixins (and Helpers) With a Container"/>
    <meta name="twitter:description" content="Updated to note that the same concerns apply to helpers. You can always see the full revision history of this item here. Today I was working on an Ember.js mixin for the new mobile web application we‚Äôre shipping at Olo, and I ran into an interesting problem when ‚Ä¶"/>
        <meta name="twitter:image" content="http://v4.chriskrycho.com/assets/images/ck.png"/>
    <link rel="me" href="http://stackoverflow.com/users/564181/chris-krycho"/>
    <link rel="me" href="https://github.com/chriskrycho"/>
    <link rel="me" href="https://patreon.com/chriskrycho"/>
    <link rel="me" href="https://soundcloud.com/chriskrycho"/>
    <link rel="me" href="https://vimeo.com/chriskrycho"/>
    <link rel="me" href="https://cash.me/$chriskrycho"/>
    <link rel="me" href="https://twitter.com/chriskrycho"/>
    <link rel="me" href="mailto:chris at chriskrycho dot com"/>
    <link rel="me" href="http://www.linkedin.com/in/chriskrycho"/>

    <link rel="openid.delegate" href="http://v4.chriskrycho.com/" />
    <link rel="openid.server" href="https://indieauth.com/openid" />

    <link rel="stylesheet" type="text/css" href="/assets/style.css"/>
    <link rel="stylesheet" type="text/css" href="/assets/fonts.css"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <link rel='stylesheet' href='//cdn.jsdelivr.net/font-hack/2.020/css/hack.min.css'>

    <link href="/favicon.png" type="image/png" rel="icon" />
    <link href="/favicon.ico" type="image/ico" rel="icon" />

    <script type="text/javascript" src="/assets/js/mtiFontTrackingCode.js"></script>


    <link rel="alternate" href="/feed.xml" type="application/rss+xml" title="All posts">
        <link rel="alternate" href="/feeds/Art.xml" type="application/rss+xml" title="Posts filed in in 'Art''">
        <link rel="alternate" href="/feeds/Blog.xml" type="application/rss+xml" title="Posts filed in in 'Blog''">
        <link rel="alternate" href="/feeds/Tech.xml" type="application/rss+xml" title="Posts filed in in 'Tech''">
        <link rel="alternate" href="/feeds/Theology.xml" type="application/rss+xml" title="Posts filed in in 'Theology''">
</head>
<body>
    <header id="site-header">
        <div class="hgroup">
            <h1 id="site-title">
<a href="http://v4.chriskrycho.com"><img class="logotype" src="/assets/images/ck.png" alt="ck"/>Chris Krycho</a>
</h1>

            <h2 id="site-subtitle">Theology, technology, life & art</h2>
        </div>

        <nav>
            <ul>
                <li class="section-title art"><a href="http://v4.chriskrycho.com/art/">Art</a></li>
                <li class="section-title blog"><a href="http://v4.chriskrycho.com/blog/">Blog</a></li>
                <li class="section-title tech"><a href="http://v4.chriskrycho.com/tech/">Tech</a></li>
                <li class="section-title theology"><a href="http://v4.chriskrycho.com/theology/">Theology</a></li>
                <li class="section-title divider" role="presentation"></li>
                <li class="section-title"><a href="http://v4.chriskrycho.com/series.html">Series</a></li>
                <li class="section-title divider" role="presentation"></li>
                <li class="section-title"><a href="http://v4.chriskrycho.com/about">About</a></li>
                <li class="section-title"><a href="http://v4.chriskrycho.com/cv">C.V.</a></li>
                <li class="section-title"><a href="http://v4.chriskrycho.com/now">Now</a></li>
            </ul>
        </nav>

    </header>


<article class="emberjs javascript software-development tech">

    <header>
<h1>Testing Ember.js Mixins (and Helpers) With a Container</h1>
<h2>Fixing "Attempting to lookup an injected property on an object without a container" errors in mixin and helper tests.</h2>    </header>

    <div class="meta">
<span class="date"><a href="http://v4.chriskrycho.com/2016/testing-emberjs-mixins-with-a-container.html" title="Testing Ember.js Mixins (and Helpers) With a Container"><i class="fa fa-fw fa-link"></i></a>June 09, 2016 (updated April 20, 2017)</span><span class="section">Filed under <a class="section-title" href="http://v4.chriskrycho.com/tech/">tech</a></span><span class="hashtag"><a class="hashtags" href="http://v4.chriskrycho.com/emberjs/">#emberjs</a><a class="hashtags" href="http://v4.chriskrycho.com/javascript/">#javascript</a><a class="hashtags" href="http://v4.chriskrycho.com/software-development/">#software development</a></span><span><a href="http://v4.chriskrycho.com/2016/testing-emberjs-mixins-with-a-container.txt">Markdown source</a></span>    </div>

    <div class="content-wrapper">


        <div class="content">

<p><i>Updated to note that the same concerns apply to helpers. You can always see the full revision history of this item <a href="https://github.com/chriskrycho/chriskrycho.com/commits/master/content/tech/ember-js-mixins-container.md">here</a>.</i></p>
<hr />
<p>Today I was working on an Ember.js <a href="http://emberjs.com/api/classes/Ember.Mixin.html#content">mixin</a> for the new mobile web application we‚Äôre shipping at Olo, and I ran into an interesting problem when trying to test it.</p>
<p>When you‚Äôre testing mixins (or helpers), you‚Äôre generally not working with the normal Ember container.<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a> In fact, the default test setup for mixins doesn‚Äôt have <em>any</em> container in play. It just looks like this (assuming you ran <code>ember generate mixin bar</code> in an app named <code>foo</code>):</p>
<pre class="js"><code>import Ember from &#39;ember&#39;;
import BarMixin from &#39;foo/mixins/bar&#39;;
import { module, test } from &#39;qunit&#39;;

module(&#39;Unit | Mixin | bar&#39;);

// Replace this with your real tests.
test(&#39;it works&#39;, function(assert) {
  let BarObject = Ember.Object.extend(BarMixin);
  let subject = BarObject.create();
  assert.ok(subject);
});</code></pre>
<p>Note two things:</p>
<ol type="1">
<li>It uses the basic Qunit <code>module</code> setup, not the ember-qunit <code>moduleFor</code> setup.</li>
<li>It assumes you‚Äôre generating a new object instance for every single test.</li>
</ol>
<p>Both of those assumptions are fine, <em>if you don‚Äôt need to interact with the container</em>. In many cases, that‚Äôs perfectly reasonable‚ÄîI‚Äôd go so far as to say that most mixins and helpers probably <em>shouldn‚Äôt</em> have any dependency on the container.</p>
<p>In the specific case I was working on, however, the point of the mixin was to abstract some common behavior which included all the interactions with a <a href="https://guides.emberjs.com/v2.6.0/applications/services/">service</a>. This meant making sure the dependency injection worked in the unit test. This in turn meant dealing with the container. So let‚Äôs see what was involved in that. (You can generalize this approach to any place in the Ember ecosystem where you need to test something which doesn‚Äôt normally have the container set up.)</p>
<p>We start by switching from the basic <code>qunit</code> helpers to using the <code>ember-qunit</code> helpers.</p>
<pre class="js"><code>// Replace this...
import { module, test } from &#39;qunit&#39;;
module(&#39;Unit | Mixin | bar&#39;);

// with this:
import { moduleFor, test } from &#39;ember-qunit&#39;;
moduleFor(&#39;mixin:bar&#39;, &#39;Unit | Mixin | Bar&#39;);</code></pre>
<p>The <code>moduleFor()</code> helper has two things going for it‚Äîone of which we <em>need</em>, and one of which isn‚Äôt strictly <em>necessary</em>, but has some nice functionality. In any case, this will help when registering a container. Those two features:</p>
<ol type="1">
<li>It does support the use of the container. In fact, it‚Äôs declaring how this mixin relates to the container in the first argument to the helper function: <code>'mixin:foo'</code> is the definition of the mixin for injection into the container.</li>
<li>Any functions we define on the options argument we can pass to the <code>moduleFor()</code> helper are available on the <code>this</code> of the test.</li>
</ol>
<p>Now, in the first version of this, I had set up a common <code>Ember.Object</code> which had mixed in the <code>BarMixin</code>, so:</p>
<pre class="js"><code>const BarObject = Ember.Object.extend(BarMixin);</code></pre>
<p>Then, in each test, I created instances of this to use:</p>
<pre class="js"><code>test(&#39;test some feature or another&#39;, function(assert) {
  const subject = BarObject.create();
  // ...do stuff and test it with `assert.ok()`, etc.
});</code></pre>
<p>The problem was that any of those tests which required a container injection always failed. Assume we have a service named <code>quux</code>, and that it‚Äôs injected into the mixin like this in <code>foo/app/mixins/bar.js</code>:</p>
<pre class="js"><code>import Ember from &#39;ember&#39;;

export default Ember.Mixin.create({
  quux: Ember.inject.service()
});</code></pre>
<p>Any test which actually tried to <em>use</em> <code>quux</code> would simply fail because of the missing container (even if you specified in the test setup that you needed the service):</p>
<pre><code>test(&#39;it uses quux somehow&#39;, function(assert) {
  const subject = BarObject.create();
  const quux = subject.get(&#39;quux&#39;);  // throws Error
});</code></pre>
<p>Specifically, you will see <code>Attempting to lookup an injected property on an object without a container</code> if you look in your console.</p>
<p>Taking advantage of the two <code>ember-qunit</code> features, though, we can handle all of this.</p>
<pre class="js"><code>import Ember from &#39;ember&#39;;
import { moduleFor, test } from &#39;ember-qunit&#39;;

const { getOwner } = Ember;

moduleFor(&#39;mixin:bar&#39;, &#39;Unit | Mixin | bar&#39;, {
  // The `needs` property in the options argument tells the test
  // framework that it needs to go find and instantiate the `quux`
  // service. (Note that if `quux` depends on other injected
  // services, you have to specify that here as well.)
  needs: [&#39;service:quux&#39;],

  // Again: any object we create in this options object will be
  // available on the `this` of every `test` function below. Here,
  // we want to get a &quot;test subject&quot; which is attached to the
  // Ember container, so that the container is available to the
  // test subject itself for retrieving the dependencies injected
  // into it (and defined above in `needs`).
  subject() {
    BarObject = Ember.Object.extend(BarMixin);

    // This whole thing works because, since we&#39;re in a
    // `moduleFor()`, `this` has the relevant method we need to
    // attach items to the container: `register()`.
    this.register(&#39;test-container:bar-object&#39;, BarObject);

    // `Ember.getOwner` is the public API for getting the
    // container to do this kind of lookup. You can use it in lots
    // of places, including but not limited to tests. Note that
    // that because of how the dependency injection works, what we
    // get back from the lookup is not `BarObject`, but an
    // instance of `BarObject`. That means that we don&#39;t need to
    // do `BarObject.create()` when we use this below; Ember
    // already did that for us.
    return getOwner(this).lookup(&#39;test-container:bar-object&#39;);
  }
});

test(&#39;the mixin+service does what it should&#39;, function(assert) {
  // We start by running the subject function defined above. We
  // now have an instance of an `Ember.Object` which has
  // `BarMixin` applied.
  const subject = this.subject();

  // Now, because we used a test helper that made the container
  // available, declared the dependencies of the mixin in `needs`,
  // and registered the object we&#39;re dealing with here, we don&#39;t
  // get an error anymore.
  const quux = subject.get(&#39;quux&#39;);
});</code></pre>
<p>So, in summary:</p>
<ol type="1">
<li>Use the <code>ember-qunit</code> helpers if you need the container.</li>
<li>Define whatever dependencies you have in <code>needs</code>, just as you would in any other test.</li>
<li>Register the mixin-derived object (whether <code>Ember.Object</code>, <code>Ember.Route</code>, <code>Ember.Component</code>, or whatever else) in a method on the options argument for <code>moduleFor()</code>. Use that to get an instance of the object and you‚Äôre off to the races!</li>
</ol>
<p>One final consideration: while in this case it made good sense to use this approach and make the service injection available for the test, there‚Äôs a reason that the tests generated by Ember CLI don‚Äôt use <code>moduleFor()</code> by default. It‚Äôs a quiet but clear signal that you should reevaluate whether this <em>is</em> in fact the correct approach.</p>
<p>In general, mixins are best used for self-contained units of functionality. If you <em>need</em> dependency injection for them, it may mean that you should think about structuring things in a different way. Can all the functionality live on the service itself? Can all of it live in the mixin instead of requiring a service? Can the service calls be delegated to whatever type is using the mixin?</p>
<p>But if not, and you <em>do</em> need a mixin which injects a service, now you know how to do it!</p>
<hr />
<p><strong>Side note:</strong> The documentation around testing mixins is relatively weak, and in general the testing docs are the weak bits in the Ember guides right now.<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> After a conversation with <a href="https://github.com/rwjblue">@rwjblue</a> on the <a href="https://ember-community-slackin.herokuapp.com">Ember Community Slack</a>, though, I was able to get a handle on the issue, and here we are. Since it stumped me, I‚Äôm guessing I‚Äôm not the only one.</p>
<p>When this happens, <em>write it up</em>. I‚Äôve been guilty of this too often in the past few months: learning something new that I couldn‚Äôt find anywhere online, and then leaving it stored in my own head. It doesn‚Äôt take a particularly long time to write a blog post like this, and if you‚Äôre stuck, chances are <em>very</em> good someone else is too.</p>
<section class="footnotes" role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p>If you‚Äôre not familiar with the ‚Äúcontainer‚Äù, this is where all the various dependencies are registered, and where Ember looks them up to inject them when you use methods like <code>Ember.inject.service()</code>.<a href="#fnref1" class="footnote-back" role="doc-backlink">‚Ü©</a></p></li>
<li id="fn2" role="doc-endnote"><p>Something I intend to help address in the next week or two via a pull request, so if you‚Äôre my Ember.js documentation team friend and you‚Äôre reading this‚Ä¶ it‚Äôs coming. üòâ<a href="#fnref2" class="footnote-back" role="doc-backlink">‚Ü©</a></p></li>
</ol>
</section>
        </div>
    </div>
</article>


    <footer id="site-footer"><section id="connect">
    <h2>Connect</h2>
    <ul class="icons">
        <li><a href="mailto:chris at chriskrycho dot com"><i class="fa fa-fw fa-envelope"></i>Email</a></li>
        <li><a href="https://github.com/chriskrycho"><i class="fa fa-fw fa-github"></i>GitHub</a></li>
        <li><a href="https://twitter.com/chriskrycho"><i class="fa fa-fw fa-twitter"></i>Twitter</a></li>
        <li><a href="https://soundcloud.com/chriskrycho"><i class="fa fa-fw fa-soundcloud"></i>SoundCloud</a></li>
        <li><a href="http://www.linkedin.com/in/chriskrycho"><i class="fa fa-fw fa-linkedin"></i>LinkedIn</a></li>
        <li><a href="https://vimeo.com/chriskrycho"><i class="fa fa-fw fa-vimeo"></i>Vimeo</a></li>
        <li><a href="http://stackoverflow.com/users/564181/chris-krycho"><i class="fa fa-fw fa-stack-overflow"></i>Stack Overflow</a></li>
    </ul>
    <h3>Support Me</h3>
    <ul class='icons'>
        <li><a href="https://patreon.com/chriskrycho"><i class='fa fa-fw fa-money'></i>Patreon</a></li>
        <li><a href="https://cash.me/$chriskrycho"><i class='fa fa-fw fa-usd'></i>Cash.me</a></li>
    </ul>
</section>
<section id="subscribe">
    <h2>Subscribe</h2>
    <ul class="icons">
        <li class="section-title">
            <a onclick="window.open('http://eepurl.com/GzswP', 'subscribe', 'width=608,height=608')">
                   <i class="fa fa-fw fa-envelope"></i>Email
            </a>
        </li>
    </ul>
    <h3>Feeds</h3>
    <ul class="icons">
        <li class="section-title">
            <a href="http://v4.chriskrycho.com/feed.xml"><i class="fa fa-fw fa-rss"></i>Everything</a>
        </li>
        <li class="section-title">
            <a href="http://v4.chriskrycho.com/feeds/Art.xml"><i class="fa fa-fw fa-rss"></i>Art</a>
        </li>
        <li class="section-title">
            <a href="http://v4.chriskrycho.com/feeds/Blog.xml"><i class="fa fa-fw fa-rss"></i>Blog</a>
        </li>
        <li class="section-title">
            <a href="http://v4.chriskrycho.com/feeds/Tech.xml"><i class="fa fa-fw fa-rss"></i>Tech</a>
        </li>
        <li class="section-title">
            <a href="http://v4.chriskrycho.com/feeds/Theology.xml"><i class="fa fa-fw fa-rss"></i>Theology</a>
        </li>
    </ul>
</section>
<section id="recent">
    <h2>Recent</h2>
    <ul>
        <li>Art: <a href="http://v4.chriskrycho.com/2019/beowulf-a-few-thoughts.html"><cite>Beowulf</cite>: A Few Thoughts
</a></li>
        <li>Blog: <a href="http://v4.chriskrycho.com/2019/no-more-alarms.html">No More Alarms</a></li>
        <li>Tech: <a href="http://v4.chriskrycho.com/2019/user-interfaces-are-api-boundaries.html">User Interfaces are API Boundaries</a></li>
        <li>Theology: <a href="http://v4.chriskrycho.com/2019/christology-god-with-us-and-for-us.html">Christology: God With Us and For Us
</a></li>
    </ul>
</section></footer>

    <script type="text/javascript">
    var MTIProjectId='a34d2e31-99b5-469a-9b81-128fc0bd9745';
    </script>

<link rel="stylesheet" href="/assets/tomorrow.min.css">
<script src="/assets/js/highlight.pack.js"></script>
<script type="text/javascript">
// Get all the <pre><code> elements, and use the <pre> element to set the <code>
// element's class so hljs will use it rather than trying to figure it out.
var preEls = document.getElementsByTagName('pre');
for (var e in preEls) {
    var pre = preEls[e];
    if (pre.firstChild && pre.firstChild.tagName === 'CODE') {
        var code = pre.firstChild;
        code.className = pre.className;
    }
}

// Then run hljs.
hljs.initHighlightingOnLoad();
</script>

<script type="text/javascript" src="/assets/js/lib.js"></script>
</body>
</html>