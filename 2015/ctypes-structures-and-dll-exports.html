<!DOCTYPE html>
<html lang="en">
<head>
    <title>Python Enums, ctypes.Structures, and DLL exports &middot; Chris Krycho</title>
    <meta name="description" content="Unfortunately, the official docs for ctypes leaves a few things out—namely, the most basic use case with from_param! Here's a simple, working example from my own development work."/>

    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1.0"/>

<link rel='me' href='https://alpha.app.net/chriskrycho' data-type='follow' data-user-id='@chriskrycho'/>    <meta property="og:url" content="http://v4.chriskrycho.com/2015/ctypes-structures-and-dll-exports.html"/>
    <meta property="og:title" content="Python Enums, ctypes.Structures, and DLL exports"/>
    <meta property="og:description" content="Unfortunately, the official docs for ctypes leaves a few things out—namely, the most basic use case with from_param! Here's a simple, working example from my own development work."/>
        <meta property="og:image" content="http://v4.chriskrycho.com//assets/images/ck.png"/>
<link rel="author" href=""/>
<link rel="me" href=""/><meta name="twitter:card" content="summary"/>
<meta name="twitter:site" content="@chriskrycho"/>
<meta name="twitter:creator" content="@chriskrycho"/>
    <meta name="twitter:title" content="Python Enums, ctypes.Structures, and DLL exports"/>
    <meta name="twitter:description" content="Unfortunately, the official docs for ctypes leaves a few things out—namely, the most basic use case with from_param! Here's a simple, working example from my own development work."/>
        <meta name="twitter:image" content="http://v4.chriskrycho.com/assets/images/ck.png"/>
    <link rel="me" href="http://stackoverflow.com/users/564181/chris-krycho"/>
    <link rel="me" href="https://github.com/chriskrycho"/>
    <link rel="me" href="https://patreon.com/chriskrycho"/>
    <link rel="me" href="https://soundcloud.com/chriskrycho"/>
    <link rel="me" href="https://vimeo.com/chriskrycho"/>
    <link rel="me" href="https://cash.me/$chriskrycho"/>
    <link rel="me" href="https://twitter.com/chriskrycho"/>
    <link rel="me" href="mailto:chris at chriskrycho dot com"/>
    <link rel="me" href="http://www.linkedin.com/in/chriskrycho"/>

    <link rel="openid.delegate" href="http://v4.chriskrycho.com/" />
    <link rel="openid.server" href="https://indieauth.com/openid" />

    <link rel="stylesheet" type="text/css" href="/assets/fonts.css"/>
    <link rel="stylesheet" type="text/css" href="/assets/style.css"/>
    <link rel="stylesheet" type="text/css" href="/assets/archival.css"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <link rel='stylesheet' href='//cdn.jsdelivr.net/font-hack/2.020/css/hack.min.css'>

    <link href="/favicon.png" type="image/png" rel="icon" />
    <link href="/favicon.ico" type="image/ico" rel="icon" />

    <script type="text/javascript" src="/assets/js/mtiFontTrackingCode.js"></script>


    <link rel="alternate" href="/feed.xml" type="application/rss+xml" title="All posts">
        <link rel="alternate" href="/feeds/Art.xml" type="application/rss+xml" title="Posts filed in in 'Art''">
        <link rel="alternate" href="/feeds/Blog.xml" type="application/rss+xml" title="Posts filed in in 'Blog''">
        <link rel="alternate" href="/feeds/Tech.xml" type="application/rss+xml" title="Posts filed in in 'Tech''">
        <link rel="alternate" href="/feeds/Theology.xml" type="application/rss+xml" title="Posts filed in in 'Theology''">
</head>
<body>
    <div id="archival-notice">This version of the site is now archived. See the current version at <a href="https://v5.chriskrycho.com">v5.chriskrycho.com</a></div>
    <header id="site-header">
        <div class="hgroup">
            <h1 id="site-title">
<a href="http://v4.chriskrycho.com"><img class="logotype" src="/assets/images/ck.png" alt="ck"/>Chris Krycho</a>
</h1>

            <h2 id="site-subtitle">Theology, technology, life & art</h2>
        </div>

        <nav>
            <ul>
                <li class="section-title"><a href="http://v4.chriskrycho.com/art/">Art</a></li>
                <li class="section-title"><a href="http://v4.chriskrycho.com/tech/">Tech</a></li>
                <li class="section-title"><a href="http://v4.chriskrycho.com/theology/">Theology</a></li>
                <li class="section-title divider" role="presentation"></li>
                <li class="section-title"><a href="http://v4.chriskrycho.com/series.html">Series</a></li>
                <li class="section-title divider" role="presentation"></li>
                <li class="section-title"><a href="http://v4.chriskrycho.com/about">About</a></li>
                <li class="section-title"><a href="http://v4.chriskrycho.com/cv">C.V.</a></li>
                <li class="section-title"><a href="http://v4.chriskrycho.com/now">Now</a></li>
            </ul>
        </nav>

    </header>


<article class="software-development tech">

    <header>
<h1>Python Enums, ctypes.Structures, and DLL exports</h1>
<h2>Illustrating the Simplest Use of ctypes Structures</h2>    </header>

    <div class="meta">
<span class="date"><a href="http://v4.chriskrycho.com/2015/ctypes-structures-and-dll-exports.html" title="Python Enums, ctypes.Structures, and DLL exports"><i class="fa fa-fw fa-link"></i></a>May 28, 2015</span><span class="section">Filed under <a class="section-title" href="http://v4.chriskrycho.com/tech/">tech</a></span><span class="hashtag"><a class="hashtags" href="http://v4.chriskrycho.com/software-development/">#software development</a></span><span><a href="http://v4.chriskrycho.com/2015/ctypes-structures-and-dll-exports.txt">Markdown source</a></span>    </div>

    <div class="content-wrapper">


        <div class="content">

<p>For one of my contracts right now, I’m writing a <code>ctypes</code> Python interface to existing C code. I got stuck and confused for quite a while on getting the interface to a given function to build correctly, and along the way had to try to understand the <code>from_param</code> class method. The official docs are… fine… but the examples provided don’t cover the most common/basic use case: defining a simple, <em>non-ctypes</em> data type as an argument to a DLL-exported function.</p>
<p>Let’s say you have a C function exported from a DLL; for convenience we’ll make it something rather silly but easy to understand:</p>
<pre class="c"><code>/** my_exported.h */
#include &quot;exports.h&quot;

typedef enum {
    ZERO,
    ONE,
    TWO
} MyEnum;

MY_API int getAnEnumValue(MyEnum anEnum);</code></pre>
<p>The implementation just gives back the integer value of the function:</p>
<pre class="c"><code>int getAnEnumValue(MyEnum anEnum) {
    return (int)anEnum;
}</code></pre>
<p>As I said, a <em>very</em> silly example. Note that you don’t technically need the <code>(int)</code> cast there; I’ve just put it in to be explicit about what we’re doing.</p>
<p>How would we use this from Python? Assuming we have a DLL named <code>my_dll</code> which exports the <code>getAnEnumValue</code> function, we’d load it up roughly like this:<a href="#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a></p>
<pre class="python"><code>import ctypes as c

my_dll = c.cdll.LoadLibrary(&#39;my_dll&#39;)</code></pre>
<p>Then, we bind to the function like this:</p>
<pre class="python"><code>get_an_enum_value = my_dll.getAnEnumValue</code></pre>
<p>Now, when you do this, you usually also supply the <code>argtypes</code> and <code>restype</code> values for these functions. If you’re like me, you’d think, “Oh, an enum—a perfect opportunity to use the <code>Enum</code> type in Python 3.4+!” and then you’d do something like this:</p>
<pre class="python"><code>import ctypes as c
from enum import IntEnum

class MyEnum(IntEnum):
    ZERO = 0
    ONE = 1
    TWO = 2

my_dll = c.cdll.LoadLibrary(&#39;my_dll&#39;)
get_an_enum_value = my_dll.getAnEnumValue
get_an_enum_value.argtypes = [MyEnum]
get_an_enum_value.restype = c.c_int</code></pre>
<p>That seems sensible enough, but as it is, it won’t work: you’ll get an error:</p>
<pre><code>TypeError: item 1 in _argtypes_ has no from_param method</code></pre>
<p>This is because <code>argtypes</code> values <em>have</em> to be either existing <code>ctypes</code> types<a href="#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a> or supply either:</p>
<ul>
<li>a <code>from_param</code> classmethod, or</li>
<li>an <code>_as_parameter_</code> attribute</li>
</ul>
<p>You can use <code>ctypes.Structure</code> subclasses natively that way, because the <code>Structure</code> class supplies its <code>from_param</code> classmethod. The same is <em>not</em> true of our custom enum class, though. As the docs put it:</p>
<blockquote>
<p>If you have defined your own classes which you pass to function calls, you have to implement a <code>from_param()</code> class method for them to be able to use them in the argtypes sequence. The <code>from_param()</code> class method receives the Python object passed to the function call, it should do a typecheck or whatever is needed to make sure this object is acceptable, and then return the object itself, its <code>_as_parameter_</code> attribute, or whatever you want to pass as the C function argument in this case. Again, the result should be an integer, string, bytes, a <code>ctypes</code> instance, or an object with an <code>_as_parameter_</code> attribute.</p>
</blockquote>
<p>So, to make the enum type work, we need to add a <code>from_param</code> class method or an <code>_as_parameter_</code> attribute to it. Thus, either of these options will work:</p>
<pre class="python"><code>class MyEnum(IntEnum):
    ZERO = 0
    ONE = 1
    TWO = 2

    # Option 1: set the _as_parameter value at construction.
    def __init__(self, value):
        self._as_parameter = int(value)

    # Option 2: define the class method `from_param`.
    @classmethod
    def from_param(cls, obj):
        return int(obj)</code></pre>
<p>In the constructor-based option, the <code>value</code> argument to the constructor is the value of the <code>Enum</code> instance. Since the value of anan <code>IntEnum</code> is always the same as the integer to whcih it is bound, we can just return <code>int(value)</code>.</p>
<p>The <code>from_param</code> approach works a little differently, but with the same results. The <code>obj</code> argument to the <code>from_param</code> method is the object instance, in this case the enumerated value itself. <em>Any</em> <code>Enum</code> with an integer value can be directly cast to <code>int</code> (though it is possible for <code>Enum</code> instances to have other values, so be careful), and since we have an <code>IntEnum</code> here, we can again just return <code>int(obj)</code> directly.</p>
<p>Now, let’s say we want to apply this pattern to more than a single <code>IntEnum</code> class, because our C code defines more than one enumeration. Extracting it to be common functionality is simple enough: just create a class that implements the class method, and inherit from it.</p>
<pre class="python"><code>class CtypesEnum(IntEnum):
    &quot;&quot;&quot;A ctypes-compatible IntEnum superclass.&quot;&quot;&quot;
    @classmethod
    def from_param(cls, obj):
        return int(obj)


class MyEnum(CtypesEnum):
    ZERO = 0
    ONE = 1
    TWO = 2</code></pre>
<p>Our final (working!) Python code, then, would be:</p>
<pre class="python"><code># Import the standard library dependencies
import ctypes as c
from enum import IntEnum


# Define the types we need.
class CtypesEnum(IntEnum):
    &quot;&quot;&quot;A ctypes-compatible IntEnum superclass.&quot;&quot;&quot;
    @classmethod
    def from_param(cls, obj):
        return int(obj)


class MyEnum(CtypesEnum):
    ZERO = 0
    ONE = 1
    TWO = 2


# Load the DLL and configure the function call.
my_dll = c.cdll.LoadLibrary(&#39;my_dll&#39;)
get_an_enum_value = my_dll.getAnEnumValue
get_an_enum_value.argtypes = [MyEnum]
get_an_enum_value.restype = c.c_int

# Demonstrate that it works.
print(get_an_enum_value(MyEnum.TWO))</code></pre>
<p>The output will be <code>2</code>, just as you’d expect!</p>
<p>An important note: The type definition we’ve provided here will work for <code>argtypes</code> or <code>restype</code> assignments, but <em>not</em> as one of the members of a custom <code>ctypes.Structure</code> type’s <code>_fields_</code> value. (Discussing how you’d go about doing that is beyond the scope of this post; the most direct approach is just to use a <code>ctypes.c_int</code> and note that it is intended to be used with a given <code>IntEnum</code>/<code>CtypesEnum</code> type.)</p>
<hr />
<p>Thanks to <a href="https://alpha.app.net/oluseyi">@oluseyi</a> for being my <a href="http://en.wikipedia.org/wiki/Rubber_duck_debugging">rubber ducky</a> while I was working this out earlier this week!</p>
<section class="footnotes" role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p>I’m leaving out the part where we build the DLL, and also the part where we locate the DLL, and only using the Windows convention. If you’re on a *nix system, you should use <code>'my_dll.so'</code> instead, and in any case you need to make sure the DLL is available in the search path.<a href="#fnref1" class="footnote-back" role="doc-backlink">↩</a></p></li>
<li id="fn2" role="doc-endnote"><p>I <em>love</em> the redundancy of “<code>ctypes</code> types,” don’t you?<a href="#fnref2" class="footnote-back" role="doc-backlink">↩</a></p></li>
</ol>
</section>
        </div>
    </div>
</article>


    <footer id="site-footer"><section id="connect">
    <h2>Connect</h2>
    <ul class="icons">
        <li><a href="mailto:chris at chriskrycho dot com"><i class="fa fa-fw fa-envelope"></i>Email</a></li>
        <li><a href="https://github.com/chriskrycho"><i class="fa fa-fw fa-github"></i>GitHub</a></li>
        <li><a href="https://twitter.com/chriskrycho"><i class="fa fa-fw fa-twitter"></i>Twitter</a></li>
        <li><a href="https://soundcloud.com/chriskrycho"><i class="fa fa-fw fa-soundcloud"></i>SoundCloud</a></li>
        <li><a href="http://www.linkedin.com/in/chriskrycho"><i class="fa fa-fw fa-linkedin"></i>LinkedIn</a></li>
        <li><a href="https://vimeo.com/chriskrycho"><i class="fa fa-fw fa-vimeo"></i>Vimeo</a></li>
        <li><a href="http://stackoverflow.com/users/564181/chris-krycho"><i class="fa fa-fw fa-stack-overflow"></i>Stack Overflow</a></li>
    </ul>
    <h3>Support Me</h3>
    <ul class='icons'>
        <li><a href="https://patreon.com/chriskrycho"><i class='fa fa-fw fa-money'></i>Patreon</a></li>
        <li><a href="https://cash.me/$chriskrycho"><i class='fa fa-fw fa-usd'></i>Cash.me</a></li>
    </ul>
</section>
<section id="subscribe">
    <h2>Subscribe</h2>
    <ul class="icons">
        <li class="section-title">
            <a onclick="window.open('http://eepurl.com/GzswP', 'subscribe', 'width=608,height=608')">
                   <i class="fa fa-fw fa-envelope"></i>Email
            </a>
        </li>
    </ul>
    <h3>Feeds</h3>
    <ul class="icons">
        <li class="section-title">
            <a href="http://v4.chriskrycho.com/feed.xml"><i class="fa fa-fw fa-rss"></i>Everything</a>
        </li>
        <li class="section-title">
            <a href="http://v4.chriskrycho.com/feeds/Art.xml"><i class="fa fa-fw fa-rss"></i>Art</a>
        </li>
        <li class="section-title">
            <a href="http://v4.chriskrycho.com/feeds/Blog.xml"><i class="fa fa-fw fa-rss"></i>Blog</a>
        </li>
        <li class="section-title">
            <a href="http://v4.chriskrycho.com/feeds/Tech.xml"><i class="fa fa-fw fa-rss"></i>Tech</a>
        </li>
        <li class="section-title">
            <a href="http://v4.chriskrycho.com/feeds/Theology.xml"><i class="fa fa-fw fa-rss"></i>Theology</a>
        </li>
    </ul>
</section>
<section id="recent">
    <h2>Recent</h2>
    <ul>
        <li>Art: <a href="http://v4.chriskrycho.com/2019/photography-ing-again.html">Photography-ing Again!</a></li>
        <li>Blog: <a href="http://v4.chriskrycho.com/2019/sympolymathesy-or-v5chriskrychocom.html">Sympolymathesy, or: v5.chriskrycho.com
</a></li>
        <li>Tech: <a href="http://v4.chriskrycho.com/2019/test-the-interface.html">Test the Interface</a></li>
        <li>Theology: <a href="http://v4.chriskrycho.com/2019/review-what-is-an-evangelical.html">Review: <cite>What is an Evangelical</cite>
</a></li>
    </ul>
</section></footer>

    <script type="text/javascript">
    var MTIProjectId='a34d2e31-99b5-469a-9b81-128fc0bd9745';
    </script>

<link rel="stylesheet" href="/assets/tomorrow.min.css">
<script src="/assets/js/highlight.pack.js"></script>
<script type="text/javascript">
// Get all the <pre><code> elements, and use the <pre> element to set the <code>
// element's class so hljs will use it rather than trying to figure it out.
var preEls = document.getElementsByTagName('pre');
for (var e in preEls) {
    var pre = preEls[e];
    if (pre.firstChild && pre.firstChild.tagName === 'CODE') {
        var code = pre.firstChild;
        code.className = pre.className;
    }
}

// Then run hljs.
hljs.initHighlightingOnLoad();
</script>

<script type="text/javascript" src="/assets/js/lib.js"></script>
</body>
</html>