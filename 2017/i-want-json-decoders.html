<!DOCTYPE html>
<html lang="en">
<head>
    <title>I Want JSON Decoders &middot; Chris Krycho</title>
    <meta name="description" content="Parsing JavaScript well is a solved problem in lots of contexts. But it's time for JavaScript to take a page from Elm."/>

    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1.0"/>

<link rel='me' href='https://alpha.app.net/chriskrycho' data-type='follow' data-user-id='@chriskrycho'/>    <meta property="og:url" content="http://v4.chriskrycho.com/2017/i-want-json-decoders.html"/>
    <meta property="og:title" content="I Want JSON Decoders"/>
    <meta property="og:description" content="Parsing JavaScript well is a solved problem in lots of contexts. But it's time for JavaScript to take a page from Elm."/>
        <meta property="og:image" content="http://v4.chriskrycho.com//assets/images/ck.png"/>
<link rel="author" href=""/>
<link rel="me" href=""/><meta name="twitter:card" content="summary"/>
<meta name="twitter:site" content="@chriskrycho"/>
<meta name="twitter:creator" content="@chriskrycho"/>
    <meta name="twitter:title" content="I Want JSON Decoders"/>
    <meta name="twitter:description" content="Parsing JavaScript well is a solved problem in lots of contexts. But it's time for JavaScript to take a page from Elm."/>
        <meta name="twitter:image" content="http://v4.chriskrycho.com/assets/images/ck.png"/>
    <link rel="me" href="http://stackoverflow.com/users/564181/chris-krycho"/>
    <link rel="me" href="https://github.com/chriskrycho"/>
    <link rel="me" href="https://patreon.com/chriskrycho"/>
    <link rel="me" href="https://soundcloud.com/chriskrycho"/>
    <link rel="me" href="https://vimeo.com/chriskrycho"/>
    <link rel="me" href="https://cash.me/$chriskrycho"/>
    <link rel="me" href="https://twitter.com/chriskrycho"/>
    <link rel="me" href="mailto:chris at chriskrycho dot com"/>
    <link rel="me" href="http://www.linkedin.com/in/chriskrycho"/>

    <link rel="openid.delegate" href="http://v4.chriskrycho.com/" />
    <link rel="openid.server" href="https://indieauth.com/openid" />

    <link rel="stylesheet" type="text/css" href="/assets/fonts.css"/>
    <link rel="stylesheet" type="text/css" href="/assets/style.css"/>
    <link rel="stylesheet" type="text/css" href="/assets/archival.css"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
    <link rel='stylesheet' href='//cdn.jsdelivr.net/font-hack/2.020/css/hack.min.css'>

    <link href="/favicon.png" type="image/png" rel="icon" />
    <link href="/favicon.ico" type="image/ico" rel="icon" />

    <script type="text/javascript" src="/assets/js/mtiFontTrackingCode.js"></script>

        <link rel="canonical" href="https://www.dailydrip.com/blog/i-want-json-decoders.html">

    <link rel="alternate" href="/feed.xml" type="application/rss+xml" title="All posts">
        <link rel="alternate" href="/feeds/Art.xml" type="application/rss+xml" title="Posts filed in in 'Art''">
        <link rel="alternate" href="/feeds/Blog.xml" type="application/rss+xml" title="Posts filed in in 'Blog''">
        <link rel="alternate" href="/feeds/Tech.xml" type="application/rss+xml" title="Posts filed in in 'Tech''">
        <link rel="alternate" href="/feeds/Theology.xml" type="application/rss+xml" title="Posts filed in in 'Theology''">
</head>
<body>
    <div id="archival-notice">This version of the site is now archived. See the next version at <a href="https://v5.chriskrycho.com">v5.chriskrycho.com</a>.</div>
    <header id="site-header">
        <div class="hgroup">
            <h1 id="site-title">
<a href="http://v4.chriskrycho.com"><img class="logotype" src="/assets/images/ck.png" alt="ck"/>Chris Krycho</a>
</h1>

            <h2 id="site-subtitle">Theology, technology, life & art</h2>
        </div>

        <nav>
            <ul>
                <li class="section-title"><a href="http://v4.chriskrycho.com/art/">Art</a></li>
                <li class="section-title"><a href="http://v4.chriskrycho.com/tech/">Tech</a></li>
                <li class="section-title"><a href="http://v4.chriskrycho.com/theology/">Theology</a></li>
                <li class="section-title divider" role="presentation"></li>
                <li class="section-title"><a href="http://v4.chriskrycho.com/series.html">Series</a></li>
                <li class="section-title divider" role="presentation"></li>
                <li class="section-title"><a href="http://v4.chriskrycho.com/about">About</a></li>
                <li class="section-title"><a href="http://v4.chriskrycho.com/cv">C.V.</a></li>
                <li class="section-title"><a href="http://v4.chriskrycho.com/now">Now</a></li>
            </ul>
        </nav>

    </header>


<article class="javascript elm typescript web-development software-development tech">

    <header>
<h1>I Want JSON Decoders</h1>
<h2>Elm taught me something important about how to handle my <abbr>API</abbr>s.</h2>    </header>

    <div class="meta">
<span class="date"><a href="http://v4.chriskrycho.com/2017/i-want-json-decoders.html" title="I Want JSON Decoders"><i class="fa fa-fw fa-link"></i></a>December 25, 2017</span><span class="section">Filed under <a class="section-title" href="http://v4.chriskrycho.com/tech/">Tech</a></span><span class="hashtag"><a class="hashtags" href="http://v4.chriskrycho.com/elm/">#elm</a><a class="hashtags" href="http://v4.chriskrycho.com/javascript/">#javascript</a><a class="hashtags" href="http://v4.chriskrycho.com/software-development/">#software development</a><a class="hashtags" href="http://v4.chriskrycho.com/typescript/">#typescript</a><a class="hashtags" href="http://v4.chriskrycho.com/web-development/">#web development</a></span><span><a href="http://v4.chriskrycho.com/2017/i-want-json-decoders.txt">Markdown source</a></span>    </div>

    <div class="content-wrapper">


        <div class="content">

<p><i class=editorial>This post was originally published at <a href="https://www.dailydrip.com/blog/i-want-json-decoders.html">DailyDrip.com</a>. They’re doing really great work over there, so I encourage you to check out their content and consider subscribing!</i></p>
<hr/>
<p>The other day, I got a report about the Ember.js app I’m working on: when a customer applied a coupon in the basket, they’d see an indication that the coupon was applied, but the basket total would still display as if it hadn’t been updated. Orders were <em>placed</em> correctly, but they wouldn’t render right. I dug around for a bit, and then discovered that it was one of the (many) places where <code>undefined</code> was biting us.</p>
<p>How did this happen? It turned out it was a perfect storm: a confusingly-designed <abbr>API</abbr> combined with a reasonable (but in this case, very unhelpful) assumption in our data layer. When the total on a given basket dropped to zero, our <abbr>API</abbr> simply didn’t send back a value on the payload at all. Instead of <code>{ total: 0, ... }</code>, there was just, well, <code>{ ... }</code> – no <code>total</code> field at all. Meanwhile, our data layer was designed to let a server send back only the fields which <em>required</em> updating. That way, you can send back partial records to indicate only what has changed, instead of having to send back the whole of what might be a very large record, or a very large collection of records.</p>
<p>The combination was terrible, though: because the server didn’t send back the <code>total</code> field at all when it dropped to <code>0</code>, the client never updated the total it displayed to the user: as far as it was concerned, the server was saying “no change here!”</p>
<p>The first and most obvious solution here, of course, is the one we implemented: we had the <abbr>API</abbr> always send back a value, even if that value was <code>0</code>. But it seems like there should be a better way.</p>
<p>Lots of languages have fairly nice facilities for parsing JavaScript. Several languages even have tools for automatically constructing local, strongly-typed data structures from the structure of a <abbr>JSON</abbr> response on an <abbr>API</abbr>. F♯’s <a href="https://docs.microsoft.com/en-us/dotnet/fsharp/tutorials/type-providers/">type providers</a> are like this and <em>really fancy</em> in the way they’ll automatically derive the type for you so you don’t even have to write it out as you would in everything from Haskell to C#. But for the most part in JavaScript, you have at most a way to map data to a local record in your data store – certainly none of those type safe guarantees. In TypeScript, you can write the types you receive out carefully – though, as I discovered in this case, probably not carefully <em>enough</em> unless you model <em>everything</em> as an optional field, and then you’re back to checking for <code>null</code> or <code>undefined</code> everywhere, and <em>why isn’t this already a solved problem?</em></p>
<p>And it turns out, it <em>is</em> a solved problem – or at least, it is in Elm, <a href="https://guide.elm-lang.org/interop/json.html">via</a> those <a href="https://guide.elm-lang.org/interop/json.html"><abbr>JSON</abbr> Decoders</a>. I don’t get to write Elm at work right now (or any time in the foreseeable future) – but if I can’t write Elm, I can at least try to steal a bunch of its great ideas and push them back into my TypeScript.</p>
<p>So… what exactly are <abbr>JSON</abbr> Decoders and how would they have solved this problem? (And why, if you’re already familiar a little with Elm and possibly feeling frustrated with decoding, are they actually worth it?)</p>
<p>A <abbr>JSON</abbr> Decoder is just a way of guaranteeing that once you’re inside the boundary of your program, you <em>always</em> have a valid instance of the data type you’ve decoded it into, <em>or</em> an error which tells you why you <em>don’t</em> have a valid instance of the data. They’re composable, so you can stack them together and take smaller decoders to build bigger ones, so if you have a complex <abbr>JSON</abbr> structure, you can define repeated substructures in it, or decoders for dissimilar sibling items in it, and use them to put together a grand decoder for your whole final structure. The decoders use the <a href="http://package.elm-lang.org/packages/elm-lang/core/5.1.1/Result"><code>Result</code></a> type, and they hand back either <code>Ok</code> with the decoded value or <code>Err</code> with the reason for the failure – and if <em>any</em> piece of a decoded type doesn’t match with what you’ve specified, you’ll end up with an <code>Err</code>.</p>
<p>Now, initially that might sound like a recipe for disaster – <abbr>JSON</abbr> payloads can be formed in weird ways all the time! – but in fact it encourages you to think through the various ways your payloads can be formed and to account for them. <em>Sometimes</em>, if the payload doesn’t have what you expect, that really does mean something is wrong either in your request or in the server-side implementation. In that case, getting an <code>Err</code> is <em>exactly</em> what you want. Other times, the server might be perfectly legitimate in sending back a variety of shapes in its response, and your responsibility is to decide how to decode it to make sense in your app. Remember, the problem I had was that I received a payload which didn’t have the data. With Elm’s decoders, I would have had three choices:</p>
<ol type="1">
<li>I could have treated this as an error, and passed that along to be dealt with in some way.</li>
<li>I could have normalized it as a 0-value payload.</li>
<li>I could have treated it <em>explicitly</em> as a no-op, maintaining whatever previous state I had in the data store, i.e. the implicit behavior of my actual data store.</li>
</ol>
<p>What I <em>couldn’t</em> do, though, is do any one of those <em>accidentally</em>. I could still support incomplete payloads (via option 3), but I’d be explicitly opting into that, and there would be an obvious place where that was the case. This would be particularly helpful in a scenario where I wasn’t also in charge of the <abbr>API</abbr>: if I couldn’t just go change it so the <abbr>API</abbr> itself had a more sensible behavior, I could enforce whichever desired behavior on my own end. More than that, with something modeled on the Elm <abbr>JSON</abbr> Decoders, I would <em>have</em> to: there would be no implicit consumption of raw <abbr>JSON</abbr>.</p>
<p>The first time I played with the Elm <abbr>JSON</abbr> Decoder approach, I thought it was a lot of work. I was used to just doing <code>JSON.parse()</code> in JS or <code>json.loads()</code> in Python. Now I needed to define a whole series of decode steps explicitly for every field in a response? Good grief! But it grew on me. More than that, I now actively miss it in my apps; I’d have been really happy not to have to spend a morning hunting down this particular bug.</p>
<p>Sometimes that explicitness can seem like quite a lot of boilerplate, and indeed it is: there’s a reason the Elm <a href="https://github.com/NoRedInk/elm-decode-pipeline">elm-decode-pipeline</a> project exists. But even given the <em>initial</em> nicety of something like F♯ type providers, I think the Elm approach has a slight edge in the long-term for <em>maintainability</em> specifically. It’s one thing to be able to just get to work right away and have a type definition you know to conform to a given <abbr>API</abbr> response. It’s something else entirely to be able to <em>know</em> that you’ve accounted for all the varieties of responses you might get (and without throwing an exception for failed <abbr>JSON</abbr> decoding at that!).</p>
<p>Given all of this, I’ve started mentally teasing out what such a <abbr>JSON</abbr> decoding library for Ember.js might look like in TypeScript. It’s a long way off, but it’s the kind of thing that I <em>really</em> want to experiment with, and that I think would make for a big win for the maintainability of our apps. Keep your eyes peeled, because I suspect this is another thing JS will steal from Elm, and that’s <em>great</em> in my book.</p>
        </div>
    </div>
</article>


    <footer id="site-footer"><section id="connect">
    <h2>Connect</h2>
    <ul class="icons">
        <li><a href="mailto:chris at chriskrycho dot com"><i class="fa fa-fw fa-envelope"></i>Email</a></li>
        <li><a href="https://github.com/chriskrycho"><i class="fa fa-fw fa-github"></i>GitHub</a></li>
        <li><a href="https://twitter.com/chriskrycho"><i class="fa fa-fw fa-twitter"></i>Twitter</a></li>
        <li><a href="https://soundcloud.com/chriskrycho"><i class="fa fa-fw fa-soundcloud"></i>SoundCloud</a></li>
        <li><a href="http://www.linkedin.com/in/chriskrycho"><i class="fa fa-fw fa-linkedin"></i>LinkedIn</a></li>
        <li><a href="https://vimeo.com/chriskrycho"><i class="fa fa-fw fa-vimeo"></i>Vimeo</a></li>
        <li><a href="http://stackoverflow.com/users/564181/chris-krycho"><i class="fa fa-fw fa-stack-overflow"></i>Stack Overflow</a></li>
    </ul>
    <h3>Support Me</h3>
    <ul class='icons'>
        <li><a href="https://patreon.com/chriskrycho"><i class='fa fa-fw fa-money'></i>Patreon</a></li>
        <li><a href="https://cash.me/$chriskrycho"><i class='fa fa-fw fa-usd'></i>Cash.me</a></li>
    </ul>
</section>
<section id="subscribe">
    <h2>Subscribe</h2>
    <ul class="icons">
        <li class="section-title">
            <a onclick="window.open('http://eepurl.com/GzswP', 'subscribe', 'width=608,height=608')">
                   <i class="fa fa-fw fa-envelope"></i>Email
            </a>
        </li>
    </ul>
    <h3>Feeds</h3>
    <ul class="icons">
        <li class="section-title">
            <a href="http://v4.chriskrycho.com/feed.xml"><i class="fa fa-fw fa-rss"></i>Everything</a>
        </li>
        <li class="section-title">
            <a href="http://v4.chriskrycho.com/feeds/Art.xml"><i class="fa fa-fw fa-rss"></i>Art</a>
        </li>
        <li class="section-title">
            <a href="http://v4.chriskrycho.com/feeds/Blog.xml"><i class="fa fa-fw fa-rss"></i>Blog</a>
        </li>
        <li class="section-title">
            <a href="http://v4.chriskrycho.com/feeds/Tech.xml"><i class="fa fa-fw fa-rss"></i>Tech</a>
        </li>
        <li class="section-title">
            <a href="http://v4.chriskrycho.com/feeds/Theology.xml"><i class="fa fa-fw fa-rss"></i>Theology</a>
        </li>
    </ul>
</section>
<section id="recent">
    <h2>Recent</h2>
    <ul>
        <li>Art: <a href="http://v4.chriskrycho.com/2019/photography-ing-again.html">Photography-ing Again!</a></li>
        <li>Blog: <a href="http://v4.chriskrycho.com/2019/sympolymathesy-or-v5chriskrychocom.html">Sympolymathesy, or: v5.chriskrycho.com
</a></li>
        <li>Tech: <a href="http://v4.chriskrycho.com/2019/test-the-interface.html">Test the Interface</a></li>
        <li>Theology: <a href="http://v4.chriskrycho.com/2019/review-what-is-an-evangelical.html">Review: <cite>What is an Evangelical</cite>
</a></li>
    </ul>
</section></footer>

    <script type="text/javascript">
    var MTIProjectId='a34d2e31-99b5-469a-9b81-128fc0bd9745';
    </script>

<link rel="stylesheet" href="/assets/tomorrow.min.css">
<script src="/assets/js/highlight.pack.js"></script>
<script type="text/javascript">
// Get all the <pre><code> elements, and use the <pre> element to set the <code>
// element's class so hljs will use it rather than trying to figure it out.
var preEls = document.getElementsByTagName('pre');
for (var e in preEls) {
    var pre = preEls[e];
    if (pre.firstChild && pre.firstChild.tagName === 'CODE') {
        var code = pre.firstChild;
        code.className = pre.className;
    }
}

// Then run hljs.
hljs.initHighlightingOnLoad();
</script>

<script type="text/javascript" src="/assets/js/lib.js"></script>
</body>
</html>