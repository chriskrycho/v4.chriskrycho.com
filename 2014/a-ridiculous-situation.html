<!DOCTYPE html>
<html lang="en">
<head>
    <title>A Ridiculous Situation &middot; Chris Krycho</title>
    <meta name="description" content="An example of just how deep the rabbit-hole can go."/>

    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1.0"/>

<link rel='me' href='https://alpha.app.net/chriskrycho' data-type='follow' data-user-id='@chriskrycho'/>    <meta property="og:url" content="http://www.chriskrycho.com/2014/a-ridiculous-situation.html"/>
    <meta property="og:title" content="A Ridiculous Situation"/>
    <meta property="og:description" content="An example of just how deep the rabbit-hole can go."/>
        <meta property="og:image" content="http://www.chriskrycho.com//assets/images/ck.png"/>
<link rel="author" href=""/>
<link rel="me" href=""/><meta name="twitter:card" content="summary"/>
<meta name="twitter:site" content="@chriskrycho"/>
<meta name="twitter:creator" content="@chriskrycho"/>
    <meta name="twitter:title" content="A Ridiculous Situation"/>
    <meta name="twitter:description" content="An example of just how deep the rabbit-hole can go."/>
        <meta name="twitter:image" content="http://www.chriskrycho.com/assets/images/ck.png"/>
    <link rel="me" href="https://soundcloud.com/chriskrycho"/>
    <link rel="me" href="https://github.com/chriskrycho"/>
    <link rel="me" href="https://vimeo.com/chriskrycho"/>
    <link rel="me" href="http://stackoverflow.com/users/564181/chris-krycho"/>
    <link rel="me" href="https://www.facebook.com/chriskrycho"/>
    <link rel="me" href="http://instagram.com/chriskrycho"/>
    <link rel="me" href="https://bitbucket.org/chriskrycho"/>
    <link rel="me" href="http://www.linkedin.com/in/chriskrycho"/>
    <link rel="me" href="https://medium.com/@chriskrycho"/>
    <link rel="me" href="mailto:chris at chriskrycho dot com"/>
    <link rel="me" href="https://twitter.com/chriskrycho"/>

    <link rel="openid.delegate" href="http://www.chriskrycho.com/" />
    <link rel="openid.server" href="https://indieauth.com/openid" />

    <link rel="stylesheet" type="text/css" href="/assets/style.css"/>
    <link rel="stylesheet" type="text/css" href="/assets/fonts.css"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">

    <link href="/favicon.png" type="image/png" rel="icon" />
    <link href="/favicon.ico" type="image/ico" rel="icon" />

    <script type="text/javascript" src="/assets/js/mtiFontTrackingCode.js"></script>

    <link rel="alternate" href="/feed.xml" type="application/rss+xml" title="All posts">
        <link rel="alternate" href="/feeds/art.xml" type="application/rss+xml" title="Posts filed in in 'Art''">
        <link rel="alternate" href="/feeds/blog.xml" type="application/rss+xml" title="Posts filed in in 'Blog''">
        <link rel="alternate" href="/feeds/micro.xml" type="application/rss+xml" title="Posts filed in in 'Micro''">
        <link rel="alternate" href="/feeds/tech.xml" type="application/rss+xml" title="Posts filed in in 'Tech''">
        <link rel="alternate" href="/feeds/theology.xml" type="application/rss+xml" title="Posts filed in in 'Theology''">
</head>
<body>
    <header id="site-header">
        <div class="hgroup">
            <h1 id="site-title">
<a href="http://www.chriskrycho.com"><img class="logotype" src="/assets/images/ck.png" alt="ck"/>Chris Krycho</a>
</h1>

            <h2 id="site-subtitle">Theology, technology, life & art</h2>
        </div>

        <nav>
            <ul>
                <li class="section-title"><a href="http://www.chriskrycho.com/about.html">About</a></li>
                <li class="section-title art"><a href="http://www.chriskrycho.com/art/">art</a></li>
                <li class="section-title tech"><a href="http://www.chriskrycho.com/tech/">tech</a></li>
                <li class="section-title theology"><a href="http://www.chriskrycho.com/theology/">theology</a></li>
                <li class="section-title divider" role="presentation"></li>
                <li class="section-title"><a href="http://www.chriskrycho.com/series.html">Series</a></li>
            </ul>
        </nav>

    </header>


<article class="software-development tech">

    <header>
<h1>A Ridiculous Situation</h1>
<h2>The craziest include structure I've ever seen.</h2>    </header>

    <div class="meta"><span class="date"><a href="http://www.chriskrycho.com/2014/a-ridiculous-situation.html"><i class="fa fa-fw fa-link"></i></a>November 07, 2014</span><span class="section">Filed under <a class="section-title" href="http://www.chriskrycho.com/tech/">tech</a></span><span class="hashtag"><a class="hashtags" href="http://www.chriskrycho.com/software-development/">#software development</a></span><span><a href="http://www.chriskrycho.com/2014/a-ridiculous-situation.txt">Markdown source</a></span></div>

    <div class="content-wrapper">


        <div class="content">

<p>One of the pieces of code I’m maintaining has an <em>absurd</em> situation in its build structure—honestly, I’m not sure how it ever compiled. For simplicity’s sake, let us assume the four following files:</p>
<ul>
<li><code>main.c</code></li>
<li><code>secondary.c</code></li>
<li><code>writer.h</code></li>
<li><code>calculator.h</code></li>
</ul>
<p>The project has many more files than this, of course, but these are the important ones for demonstrating this particular piece of insanity (which shows up <em>many</em> places in the codebase).</p>
<p>I’m reproducing here some dummy code representing an <em>actual set of relationships in the codebase</em>. The functions and module nameshave been changed; the relationships between the pieces of code have not.<a href="#fn1" class="footnoteRef" id="fnref1"><sup>1</sup></a> When I started trying to build the program that included what I am representing as <code>main.c</code> below, this is the basic structure I found:</p>
<section id="main.cpp" class="level3">
<h3><code>main.cpp</code></h3>
<p>This is the main module of the program. In the actual code in which I found this particular morass, it was actually code generated by the UI builder in Visual Studio 6<a href="#fn2" class="footnoteRef" id="fnref2"><sup>2</sup></a> and then turned into an unholy mess by a developer whose idea of good programming involved coupling the various parts of the code as tightly as possible.<a href="#fn3" class="footnoteRef" id="fnref3"><sup>3</sup></a></p>
<pre class="c"><code>#include &quot;calculator.h&quot;
#include &quot;secondary.h&quot;

int a=0, int b=0;

int addNumbers(a, b) {
    return a+b;
}

void doBadThingsWithGlobals(int * someNumber) {
    a = 6;
    *someOtherNumber = 5;
}

#include &quot;writer.h&quot;

void main() {
    a = 3;
    doBadThingsWithGlobals(&amp;b);
    addNumbers(a, b);
    doStuffWithNumbers(a,b);
    subtractNumbers(b, a);
}

// More insanity follows...</code></pre>
<p>Yes, the main function and the <code>doBadThingsWithGlobals</code> function are both modifying global state, and yes, there is an include statement midway down through the module. (Just wait till you see what it does.)</p>
</section>
<section id="secondary" class="level3">
<h3>“secondary”</h3>
<p>Here is a secondary module which has been somewhat cleaned up. It has normal relationships between header and source files, and includes all its dependency headers at the top of the file. It has a header which defines the public API for the module, and that even has inclusion guards on it.</p>
<section id="secondary.h" class="level4">
<h4><code>secondary.h</code></h4>
<pre class="c"><code>#ifndef SECONDARY_H
#define SECONDARY_H

int doStuffWithNumbers();

#endif SECONDARY_H</code></pre>
</section>
<section id="secondary.c" class="level4">
<h4><code>secondary.c</code></h4>
<p>The <code>doStuffWithNumbers</code> function here calls <code>addNumbers</code>:</p>
<pre class="c"><code>#include &quot;secondary.h&quot;
#include &quot;calculator.h&quot;

int doStuffWithNumbers(int x, int y) {
    addNumbers(x, y);
}</code></pre>
<p><em>But wait!</em> you say, <em>That function isn’t defined here!</em> Ah, and you would be right, except that it doesn’t refer to the <code>addNumbers</code> function in <code>main.c</code>. It refers to a function implementation in <code>calculator.h</code>.</p>
</section>
</section>
<section id="calculator.h" class="level3">
<h3><code>calculator.h</code></h3>
<pre class="c"><code>int addNumbers(int p, int q) {
    return p + q;
}

int subtractNumbers(int r, int s) {
    return r - s;
}</code></pre>
<p>Strangely, this <code>addNumbers</code> function is identical to the one in <code>main.c</code>. Even <em>more</em> strangely, it is defined—not merely declared, actually defined—in the header file! Nor is this the only such function. Look at the details of <code>writer.h</code>, which was mysteriously included above in the middle of the main module.</p>
</section>
<section id="writer.h" class="level3">
<h3><code>writer.h</code></h3>
<pre class="c"><code>void writeStuff() {
    fprintf(stdout, &quot;a: %d, b: %d&quot;, a, b);
}</code></pre>
<p>Once again, we have a full-fledged implementation in the header file. Why, you ask? Presumably because the developer responsible for writing this code never quite got his head around how C’s build system works. The entirety of one of the central components of this software—an element that in any normal build would be a common library—was a single, approximately 2,000-line <em>header file</em>. (Say hello to <code>calculator.h</code> up there; that’s what I’m abstracting away for this example.)<a href="#fn4" class="footnoteRef" id="fnref4"><sup>4</sup></a></p>
<p>Worse: it is printing the values of <code>a</code> and <code>b</code>, and no, I am not skipping some part of <code>writer.h</code>. It is getting those from <code>main.c</code>, because it was included after they were defined, and the build process essentially drops this header inline into <code>main.c</code> before it compilation.<a href="#fn5" class="footnoteRef" id="fnref5"><sup>5</sup></a> So here we have a header file with the implementation of a given piece of code, included in a specific location and defined in such a way that if you change where it is included, it will no longer function properly (since the variables will not have been defined!)</p>
<p>Worse, there are conflicting definitions for one of the functions used in <code>main.c</code>, and because of its dependency on <em>other</em> functions in <code>calculator.h</code> (e.g. <code>subtractNumbers</code> in this mock-up), it cannot be removed! Moreover, given the many places <code>calculator.h</code> is referenced throughout the code base, it is non-trivial to refactor it.<a href="#fn6" class="footnoteRef" id="fnref6"><sup>6</sup></a></p>
<p>If this sounds insane… that’s because it is.</p>
<p>If you’re curious how I dealt with it, well… I renamed the <code>addNumbers()</code> function in <code>main.c</code> to <code>_addNumbers()</code> and put a loud, angry <code>TODO</code> on it for the current release, because the only way to fix it is to refactor this whole giant mess.</p>
<p>The takeaway of the story, if there is one, is that people will do crazier, weirder, worse things than you can possibly imagine when they don’t understand the tools they are using and just hack at them till they can make them work. The moral of the story? I’m not sure. Run away from crazy code like this? Be prepared to spend your life refactoring?</p>
<p>How about: try desperately <em>not</em> to leave this kind of thing for the person following you.</p>
<div id="refs" class="references">

</div>
</section>
<section class="footnotes">
<hr />
<ol>
<li id="fn1"><p>That’s actually not <em>wholly</em> true, because these pieces of code are also duplicated in numerous places throughout the codebase. We’ve eliminated as many as possible at present… but not all of them, courtesy of the crazy dependency chains that exist. Toss in a dependency on Visual Studio 6 for some of those components, and, well… suffice it to say that we’re just happy there are only two versions floating around instead of the seven that were present when I started working with this codebase two and a half years ago.<a href="#fnref1">↩</a></p></li>
<li id="fn2"><p>Yes, <a href="http://en.wikipedia.org/wiki/Microsoft_Visual_Studio#Visual_Studio_6.0_.281998.29"><em>that</em></a> Visual Studio 6. The one from 1998. Yes, that’s insane. No, we haven’t managed to get rid of it yet, though we’re close. So close.<a href="#fnref2">↩</a></p></li>
<li id="fn3"><p>I am not joking. Multi-thousand line functions constituting the entirety of a program are not just <em>normal</em>, they are pretty much the only way that programmer ever wrote. When you see the code samples below, you will see why: someone was lacking an understanding of C’s build system.<a href="#fnref3">↩</a></p></li>
<li id="fn4"><p>Also, that’s the piece of code of which I found seven different versions in various places when I started. Seven!<a href="#fnref4">↩</a></p></li>
<li id="fn5"><p>I once ran into some code working on a different project for an entirely different client where there had been a strict 1,000-line limit to C source files, as part of an attempt to enforce some discipline in modularizing the code. Instead of embracing modularity, the developers just got in the habit of splitting the source file and adding <code>#include</code> statements at the end of each file so that they could just keep writing their non-modular code.<a href="#fnref5">↩</a></p></li>
<li id="fn6"><p>I have tried. Twice. I’m hoping that the third time <em>will</em> be the charm.<a href="#fnref6">↩</a></p></li>
</ol>
</section>
        </div>
    </div>
</article>


    <footer id="site-footer"><section id="connect">
    <h2>Connect</h2>
    <ul class="icons">
        <li><a href="https://twitter.com/chriskrycho"><i class="fa fa-fw fa-twitter"></i>Twitter</a></li>
        <li><a href="mailto:chris at chriskrycho dot com"><i class="fa fa-fw fa-envelope"></i>Email</a></li>
        <li><a href="https://github.com/chriskrycho"><i class="fa fa-fw fa-github"></i>GitHub</a></li>
        <li><a href="https://medium.com/@chriskrycho"><i class="fa fa-fw fa-medium"></i>Medium</a></li>
        <li><a href="https://soundcloud.com/chriskrycho"><i class="fa fa-fw fa-soundcloud"></i>SoundCloud</a></li>
        <li><a href="http://instagram.com/chriskrycho"><i class="fa fa-fw fa-instagram"></i>Instagram</a></li>
        <li><a href="http://www.linkedin.com/in/chriskrycho"><i class="fa fa-fw fa-linkedin"></i>LinkedIn</a></li>
        <li><a href="https://vimeo.com/chriskrycho"><i class="fa fa-fw fa-vimeo"></i>Vimeo</a></li>
        <li><a href="http://stackoverflow.com/users/564181/chris-krycho"><i class="fa fa-fw fa-stack-overflow"></i>Stack Overflow</a></li>
    </ul>
</section>
<section id="subscribe">
    <h2>Subscribe</h2>
    <ul class="icons">
        <li class="section-title">
            <a href="http://www.chriskrycho.com/feed.xml"><i class="fa fa-fw fa-rss"></i>Everything</a>
        </li>
        <li class="section-title">
            <a href="http://www.chriskrycho.com/feeds/art.xml"><i class="fa fa-fw fa-rss"></i>art</a>
        </li>
        <li class="section-title">
            <a href="http://www.chriskrycho.com/feeds/blog.xml"><i class="fa fa-fw fa-rss"></i>blog</a>
        </li>
        <li class="section-title">
            <a href="http://www.chriskrycho.com/feeds/micro.xml"><i class="fa fa-fw fa-rss"></i>micro</a>
        </li>
        <li class="section-title">
            <a href="http://www.chriskrycho.com/feeds/tech.xml"><i class="fa fa-fw fa-rss"></i>tech</a>
        </li>
        <li class="section-title">
            <a href="http://www.chriskrycho.com/feeds/theology.xml"><i class="fa fa-fw fa-rss"></i>theology</a>
        </li>
    </ul>
</section>
<section id="recent">
    <h2>Recent</h2>
    <ul>
        <li>Art: <a href="http://www.chriskrycho.com/2016/even-easter-morning.html">even Easter morning</a></li>
        <li>Blog: <a href="http://www.chriskrycho.com/2016/run-with-me.html">Run With Me!</a></li>
        <li>Tech: <a href="http://www.chriskrycho.com/2016/ulysses-byword-and-just-right.html">Ulysses, Byword, and “Just Right”</a></li>
        <li>Theology: <a href="http://www.chriskrycho.com/2016/god-is-with-us.html">God is With Us</a></li>
    </ul>
</section></footer>

    <script async src="http://code.bib.ly/bibly.min.js"></script>
    <link href="http://code.bib.ly/bibly.min.css" rel="stylesheet" />
    <script type="text/javascript">
    var MTIProjectId='a34d2e31-99b5-469a-9b81-128fc0bd9745';
    </script>

<link rel="stylesheet" href="/assets/tomorrow.min.css">
<script src="/assets/js/highlight.pack.js"></script>
<script type="text/javascript">
// Get all the <pre><code> elements, and use the <pre> element to set the <code>
// element's class so hljs will use it rather than trying to figure it out.
var preEls = document.getElementsByTagName('pre');
for (var e in preEls) {
    var pre = preEls[e];
    if (pre.firstChild && pre.firstChild.tagName === 'CODE') {
        var code = pre.firstChild;
        code.className = pre.className;
    }
}

// Then run hljs.
hljs.initHighlightingOnLoad();
</script>

<script type="text/javascript" src="/assets/js/lib.js"></script>
</body>
</html>