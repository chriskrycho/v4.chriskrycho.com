<!DOCTYPE html>
<html lang="en">
<head>
    <title>A Ridiculous Situation &middot; Chris Krycho</title>
    <meta name="description" content="An example of just how deep the rabbit-hole can go."/>

    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1.0"/>

<link rel='me' href='https://alpha.app.net/chriskrycho' data-type='follow' data-user-id='@chriskrycho'/>    <meta property="og:url" content="http://www.chriskrycho.com/2014/a-ridiculous-situation.html"/>
    <meta property="og:title" content="A Ridiculous Situation"/>
        <meta property="og:description" content="An example of just how deep the rabbit-hole can go."/>
        <meta property="og:image" content="http://www.chriskrycho.com//assets/images/ck.png"/>
<link rel="author" href=""/><meta name="twitter:card" content="summary"/>
<meta name="twitter:site" content="@chriskrycho"/>
<meta name="twitter:creator" content="@chriskrycho"/>
        <meta name="twitter:title" content="A Ridiculous Situation"/>
        <meta name="twitter:description" content="An example of just how deep the rabbit-hole can go."/>
        <meta name="twitter:image" content="http://www.chriskrycho.com//assets/images/ck.png"/>

    <link rel="stylesheet" type="text/css" href="http://www.chriskrycho.com/assets/style.css"/>
    <link rel="stylesheet" type="text/css" href="http://www.chriskrycho.com/assets/fonts.css"/>
    <link rel="stylesheet" type="text/css" href="http://www.chriskrycho.com/assets/icons.css"/>

    <link href="http://www.chriskrycho.com/favicon.png" type="image/png" rel="icon" />
    <link href="http://www.chriskrycho.com/favicon.ico" type="image/ico" rel="icon" />

    <script type="text/javascript" src="//code.jquery.com/jquery-2.1.0.min.js"></script>
    <script type="text/javascript" src="/assets/js/bigfoot.min.js"></script>
    <script type="text/javascript">$.bigfoot();</script>
        <script type="text/javascript" src="/assets/js/highlight.pack.js"></script>
        <script type="text/javascript">hljs.initHighlightingOnLoad();</script>
    <script src="/assets/js/reftagger.js"></script>


</head>
<body>
    <header id="site-header">
        <div class="hgroup">
            <h1 id="site-title">
<a href="http://www.chriskrycho.com"><img class="logotype" src="/assets/images/ck.png" alt="ck"/>Chris Krycho</a>
</h1>

            <h2 id="site-subtitle">Creativity, reflection, & varied endeavors<br class="optional"/> by a peculiar fellow</h2>
        </div>

        <nav>
            <ul>
                <li class="section-title"><a href="http://www.chriskrycho.com/about.html">About</a></li>
                <li class="section-title"><a href="http://www.chriskrycho.com/art/">art</a></li>
                <li class="section-title"><a href="http://www.chriskrycho.com/blog/">blog</a></li>
                <li class="section-title"><a href="http://www.chriskrycho.com/tech/">tech</a></li>
                <li class="section-title"><a href="http://www.chriskrycho.com/theology/">theology</a></li>
            </ul>
        </nav>

    </header>


<article class='code'>

    <header>
<h1>A Ridiculous Situation</h1>
<h2>The craziest include structure I've ever seen.</h2>    </header>

    <div class="meta"><span class="date"><a href="http://www.chriskrycho.com/2014/a-ridiculous-situation.html"><i class="fa fa-fw fa-link"></i></a>November 07, 2014</span><span class="section">Filed under <a class="section-title" href="http://www.chriskrycho.com/tech/">tech</a></span><span class="hashtag"><a class="hashtags" href="http://www.chriskrycho.com/software-development/">#software development</a></span><span><a href="http://www.chriskrycho.com/2014/a-ridiculous-situation.txt">Markdown source</a></span></div>

    <div class="content-wrapper">


        <div class="content">

<p>One of the pieces of code I&#8217;m maintaining has an <em>absurd</em> situation in its build
structure&#8212;honestly, I&#8217;m not sure how it ever compiled. For simplicity&#8217;s sake,
let us assume the four following files:</p>
<ul>
<li><code>main.c</code></li>
<li><code>secondary.c</code></li>
<li><code>writer.h</code></li>
<li><code>calculator.h</code></li>
</ul>
<p>The project has many more files than this, of course, but these are the
important ones for demonstrating this particular piece of insanity (which shows
up <em>many</em> places in the codebase).</p>
<p>I&#8217;m reproducing here some dummy code representing an <em>actual set of 
relationships in the codebase</em>. The functions and module nameshave been changed;
the relationships between the pieces of code have not.<sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup> When I started trying
to build the program that included what I am representing as <code>main.c</code> below,
this is the basic structure I found:</p>
<h3 id="maincpp"><code>main.cpp</code></h3>
<p>This is the main module of the program. In the actual code in which I found this
particular morass, it was actually code generated by the UI builder in Visual
Studio 6<sup id="fnref:2"><a class="footnote-ref" href="#fn:2" rel="footnote">2</a></sup> and then turned into an unholy mess by a developer whose idea of
good programming involved coupling the various parts of the code as tightly as
possible.<sup id="fnref:3"><a class="footnote-ref" href="#fn:3" rel="footnote">3</a></sup></p>
<pre><code class="c">#include &quot;calculator.h&quot;
#include &quot;secondary.h&quot;

int a=0, int b=0;

int addNumbers(a, b) {
    return a+b;
}

void doBadThingsWithGlobals(int * someNumber) {
    a = 6;
    *someOtherNumber = 5;
}

#include &quot;writer.h&quot;

void main() {
    a = 3;
    doBadThingsWithGlobals(&amp;b);
    addNumbers(a, b);
    doStuffWithNumbers(a,b);
    subtractNumbers(b, a);
}

// More insanity follows...
</code></pre>

<p>Yes, the main function and the <code>doBadThingsWithGlobals</code> function are both
modifying global state, and yes, there is an include statement midway down
through the module. (Just wait till you see what it does.)</p>
<h3 id="secondary">&#8220;secondary&#8221;</h3>
<p>Here is a secondary module which has been somewhat cleaned up. It has normal
relationships between header and source files, and includes all its dependency
headers at the top of the file. It has a header which defines the public API for
the module, and that even has inclusion guards on it.</p>
<h4 id="secondaryh"><code>secondary.h</code></h4>
<pre><code class="c">#ifndef SECONDARY_H
#define SECONDARY_H

int doStuffWithNumbers();

#endif SECONDARY_H
</code></pre>

<h4 id="secondaryc"><code>secondary.c</code></h4>
<p>The <code>doStuffWithNumbers</code> function here calls <code>addNumbers</code>:</p>
<pre><code class="c">#include &quot;secondary.h&quot;
#include &quot;calculator.h&quot;

int doStuffWithNumbers(int x, int y) {
    addNumbers(x, y);
}
</code></pre>

<p><em>But wait!</em> you say, <em>That function isn&#8217;t defined here!</em> Ah, and you would be
right, except that it doesn&#8217;t refer to the <code>addNumbers</code> function in <code>main.c</code>. It
refers to a function implementation in <code>calculator.h</code>.</p>
<h3 id="calculatorh"><code>calculator.h</code></h3>
<pre><code class="c">int addNumbers(int p, int q) {
    return p + q;
}

int subtractNumbers(int r, int s) {
    return r - s;
}
</code></pre>

<p>Strangely, this <code>addNumbers</code> function is identical to the one in <code>main.c</code>. Even
<em>more</em> strangely, it is defined&#8212;not merely declared, actually defined&#8212;in
the header file! Nor is this the only such function. Look at the details of
<code>writer.h</code>, which was mysteriously included above in the middle of the main
module.</p>
<h3 id="writerh"><code>writer.h</code></h3>
<pre><code class="c">void writeStuff() {
    fprintf(stdout, &quot;a: %d, b: %d&quot;, a, b);
}
</code></pre>

<p>Once again, we have a full-fledged implementation in the header file. Why, you
ask? Presumably because the developer responsible for writing this code never
quite got his head around how C&#8217;s build system works. The entirety of one of the
central components of this software&#8212;an element that in any normal build would
be a common library&#8212;was a single, approximately 2,000-line <em>header file</em>. (Say
hello to <code>calculator.h</code> up there; that&#8217;s what I&#8217;m abstracting away for this
example.)<sup id="fnref:4"><a class="footnote-ref" href="#fn:4" rel="footnote">4</a></sup></p>
<p>Worse: it is printing the values of <code>a</code> and <code>b</code>, and no, I am not skipping some
part of <code>writer.h</code>. It is getting those from <code>main.c</code>, because it was included
after they were defined, and the build process essentially drops this header
inline into <code>main.c</code> before it compilation.<sup id="fnref:5"><a class="footnote-ref" href="#fn:5" rel="footnote">5</a></sup> So here we have a header file
with the implementation of a given piece of code, included in a specific
location and defined in such a way that if you change where it is included, it
will no longer function properly (since the variables will not have been defined!)</p>
<p>Worse, there are conflicting definitions for one of the functions used in
<code>main.c</code>, and because of its dependency on <em>other</em> functions in <code>calculator.h</code>
(e.g. <code>subtractNumbers</code> in this mock-up), it cannot be removed! Moreover, given
the many places <code>calculator.h</code> is referenced throughout the code base, it is
non-trivial to refactor it.<sup id="fnref:6"><a class="footnote-ref" href="#fn:6" rel="footnote">6</a></sup></p>
<p>If this sounds insane&#8230; that&#8217;s because it is.</p>
<p>If you&#8217;re curious how I dealt with it, well&#8230; I renamed the <code>addNumbers()</code> 
function in <code>main.c</code> to <code>_addNumbers()</code> and put a loud, angry <code>TODO</code> on it for the
current release, because the only way to fix it is to refactor this whole giant
mess.</p>
<p>The takeaway of the story, if there is one, is that people will do crazier,
weirder, worse things than you can possibly imagine when they don&#8217;t understand
the tools they are using and just hack at them till they can make them work. The
moral of the story? I&#8217;m not sure. Run away from crazy code like this? Be
prepared to spend your life refactoring?</p>
<p>How about: try desperately <em>not</em> to leave this kind of thing for the person
following you.</p>
<div class="footnote">
<hr />
<ol>
<li id="fn:1">
<p>That&#8217;s actually not <em>wholly</em> true, because these pieces of code are also
duplicated in numerous places throughout the codebase. We&#8217;ve eliminated as
many as possible at present&#8230; but not all of them, courtesy of the crazy
dependency chains that exist. Toss in a dependency on Visual Studio 6 for
some of those components, and, well&#8230; suffice it to say that we&#8217;re just
happy there are only two versions floating around instead of the seven that
were present when I started working with this codebase two and a half years
ago.&#160;<a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">&#8617;</a></p>
</li>
<li id="fn:2">
<p>Yes, <a href="http://en.wikipedia.org/wiki/Microsoft_Visual_Studio#Visual_Studio_6.0_.281998.29"><em>that</em></a> Visual Studio 6. The one from 1998. Yes, that&#8217;s insane.
No, we haven&#8217;t managed to get rid of it yet, though we&#8217;re close. So close.&#160;<a class="footnote-backref" href="#fnref:2" rev="footnote" title="Jump back to footnote 2 in the text">&#8617;</a></p>
</li>
<li id="fn:3">
<p>I am not joking. Multi-thousand line functions constituting the entirety
of a program are not just <em>normal</em>, they are pretty much the only way that
programmer ever wrote. When you see the code samples below, you will see
why: someone was lacking an understanding of C&#8217;s build system.&#160;<a class="footnote-backref" href="#fnref:3" rev="footnote" title="Jump back to footnote 3 in the text">&#8617;</a></p>
</li>
<li id="fn:4">
<p>Also, that&#8217;s the piece of code of which I found seven different versions
in various places when I started. Seven!&#160;<a class="footnote-backref" href="#fnref:4" rev="footnote" title="Jump back to footnote 4 in the text">&#8617;</a></p>
</li>
<li id="fn:5">
<p>I once ran into some code working on a different project for an entirely
different client where there had been a strict 1,000-line limit to C source
files, as part of an attempt to enforce some discipline in modularizing the
code. Instead of embracing modularity, the developers just got in the habit
of splitting the source file and adding <code>#include</code> statements at the end of
each file so that they could just keep writing their non-modular code.&#160;<a class="footnote-backref" href="#fnref:5" rev="footnote" title="Jump back to footnote 5 in the text">&#8617;</a></p>
</li>
<li id="fn:6">
<p>I have tried. Twice. I&#8217;m hoping that the third time <em>will</em> be the charm.&#160;<a class="footnote-backref" href="#fnref:6" rev="footnote" title="Jump back to footnote 6 in the text">&#8617;</a></p>
</li>
</ol>
</div>        </div>
    </div>
    </article>


    <footer id="site-footer"><section id="connect">
    <h1>Connect</h1>
    <h2>Social</h2>
    <ul class="icons">
        <li><a href="https://app.net/chriskrycho"><i class="fa fa-fw fa-adn"></i>App.net</a></li>
        <li><a href="https://twitter.com/chriskrycho"><i class="fa fa-fw fa-twitter"></i>Twitter</a></li>
        <li><a href="https://www.facebook.com/chriskrycho"><i class="fa fa-fw fa-facebook"></i>Facebook</a></li>
        <li><a href="https://soundcloud.com/chriskrycho"><i class="fa fa-fw fa-cloud"></i>SoundCloud</a></li>
        <li><a href="http://instagram.com/chriskrycho"><i class="fa fa-fw fa-instagram"></i>Instagram</a></li>
        <li><a href="http://www.linkedin.com/in/chriskrycho"><i class="fa fa-fw fa-linkedin"></i>LinkedIn</a></li>
    </ul>
    <h2>Software</h2>
    <ul class="icons">
        <li><a href="https://github.com/chriskrycho"><i class="fa fa-fw fa-github"></i>GitHub</a></li>
        <li><a href="https://bitbucket.org/chriskrycho"><i class="fa fa-fw fa-bitbucket"></i>Bitbucket</a></li>
        <li><a href="http://stackoverflow.com/users/564181/chris-krycho"><i class="fa fa-fw fa-stack-overflow"></i>Stack Overflow</a></li>
    </ul>
</section>
<section id="navigate">
    <h1>Navigate</h1>
    <h2>Read</h2>
    <ul>
        <li><a href="http://www.chriskrycho.com/archives.html">Everything</a></li>
        <li class="section-title"><a href="http://www.chriskrycho.com/art/">art</a></li>
        <li class="section-title"><a href="http://www.chriskrycho.com/blog/">blog</a></li>
        <li class="section-title"><a href="http://www.chriskrycho.com/tech/">tech</a></li>
        <li class="section-title"><a href="http://www.chriskrycho.com/theology/">theology</a></li>
    </ul>
    <h2>Get Updates</h2>
    <ul class="inline">
        <li class="section-title">Everything</li>
        <li><a href="http://www.chriskrycho.com/feed.xml"><i class="fa fa-rss"></i>Feed</a></li>
        <li><a href="https://broadcast.app.net/46224/chriskrychocom-all/"><i class="fa fa-envelope-o"></i>Subscribe</a></li>
    </ul>
    <ul class="inline">
        <li class="section-title">art</li>
        <li><a href="http://www.chriskrycho.com/feeds/art.xml"><i class="fa fa-rss"></i>Feed</a></li>
        <li><a href="https://broadcast.app.net/46225/chriskrychocom-art/"><i class="fa fa-envelope-o"></i>Subscribe</a></li>
    </ul>
    <ul class="inline">
        <li class="section-title">blog</li>
        <li><a href="http://www.chriskrycho.com/feeds/blog.xml"><i class="fa fa-rss"></i>Feed</a></li>
        <li><a href="https://broadcast.app.net/46226/chriskrychocom-blog/"><i class="fa fa-envelope-o"></i>Subscribe</a></li>
    </ul>
    <ul class="inline">
        <li class="section-title">tech</li>
        <li><a href="http://www.chriskrycho.com/feeds/tech.xml"><i class="fa fa-rss"></i>Feed</a></li>
        <li><a href="https://broadcast.app.net/46227/chriskrychocom-tech/"><i class="fa fa-envelope-o"></i>Subscribe</a></li>
    </ul>
    <ul class="inline">
        <li class="section-title">theology</li>
        <li><a href="http://www.chriskrycho.com/feeds/theology.xml"><i class="fa fa-rss"></i>Feed</a></li>
        <li><a href="https://broadcast.app.net/46228/chriskrychocom-theology/"><i class="fa fa-envelope-o"></i>Subscribe</a></li>
    </ul>
</section>
<section id="recent">
    <h1>Recent</h1>
    <h2 class="section-title">art</h2>
    <ul>
        <li><a href="http://www.chriskrycho.com/2015/speak-the-truth-in-beauty.html">Speak the Truth in Beauty</a></li>
        <li><a href="http://www.chriskrycho.com/2014/i-wrote-it-wrong.html">I Wrote It Wrong</a></li>
        <li><a href="http://www.chriskrycho.com/2014/let-the-peoples-praise-you.html">Let The Peoples Praise You</a></li>
    </ul>
    <h2 class="section-title">blog</h2>
    <ul>
        <li><a href="http://www.chriskrycho.com/2015/early-2015-family.html">The State of Our Family in Early 2015</a></li>
        <li><a href="http://www.chriskrycho.com/2015/joy-good-tools.html">The Joy of Good Tools</a></li>
        <li><a href="http://www.chriskrycho.com/2015/public-ish-plans.html">Public-ish Plans</a></li>
    </ul>
    <h2 class="section-title">tech</h2>
    <ul>
        <li><a href="http://www.chriskrycho.com/2015/the-new-macbook.html">The New Macbook</a></li>
        <li><a href="http://www.chriskrycho.com/2015/the-tablet-productivity-problem.html">The Tablet “Productivity” Problem</a></li>
        <li><a href="http://www.chriskrycho.com/2015/facebooks-security-requirements.html">Facebook's "Security" Requirements</a></li>
    </ul>
    <h2 class="section-title">theology</h2>
    <ul>
        <li><a href="http://www.chriskrycho.com/2015/hcsb-thoughts.html">“Optimal Equivalence”</a></li>
        <li><a href="http://www.chriskrycho.com/2014/startlement.html">Startlement</a></li>
        <li><a href="http://www.chriskrycho.com/2014/on-the-incarnation.html">On the Incarnation</a></li>
    </ul>
</section></footer>
</body>
</html>